@using MediatR
@using MediatRPortal.Client.Features.Quotes.Pages.Designer.Components.Charges.CQRS.Commands

@inject IMediator Mediator

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3 mb-n1" />
            @Charge.Description
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            @foreach (var item in _columns)
            {
                <MudItem>
                    <MudTextField Label="@item.Key.ToString()" T="double?"
                                  Value="item.Value" ValueChanged="value => HandleValueChanged(item.Key, value)" />
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Error" OnClick="SendModifyCharge">Modify</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [CascadingParameter]
    private MudDialogInstance? MudDialog { get; set; }

    [CascadingParameter]
    private Guid SessionId { get; set; }

    [Parameter]
    public required RouteModel Route { get; set; }
    [Parameter]
    public required ChargeModel Charge { get; set; }

    private Dictionary<ChargeColumn, double?> _columns = [];

    protected override void OnInitialized()
    {
        foreach (var item in Charge.Columns)
        {
            _columns.Add(item.Key, item.Value);
        }
    }

    private void HandleValueChanged(ChargeColumn key, double? value)
    {
        if (_columns.ContainsKey(key))
        {
            _columns[key] = value;
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private async Task SendModifyCharge()
    {
        // MudDialog?.Close(DialogResult.Ok(Charge with { Columns = _columns }));
        // Just for tests purposes, we will use mediator to send the notification

        var newCharge = Charge with { Columns = _columns };

        await Mediator.Send(new UpdateChargeCommand(SessionId, newCharge));

        MudDialog?.Close(DialogResult.Ok(Charge with { Columns = _columns }));
    }
}